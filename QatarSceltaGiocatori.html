<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Selezione Vincitore Torneo</title>
    <link rel="stylesheet" href="QatarSceltaGiocatori.css" />
  </head>
  <body>
    <h2>Seleziona il vincitore</h2>

    <form id="selection-form">
      <label for="email">La tua email:</label>
      <input type="email" id="email" name="email" required />

      <h2>Seleziona i semifinalisti (max 4)</h2>
      <div id="players-list" class="players-container"></div>

      <h2>Semifinalisti selezionati</h2>
      <div id="semifinalists-list" class="semifinalists-container"></div>

      <h3>Vincitore:</h3>
      <span id="winner-name"
        >Seleziona prima i semifinalisti e poi il vincitore</span
      >

      <button type="submit">Invia Selezione</button>
    </form>

    <script>
      fetch("./DOHA_1-100_atp_players.json")
        .then((response) => response.json())
        .then((players) => {
          const playersList = document.getElementById("players-list");
          const semifinalistsList =
            document.getElementById("semifinalists-list");
          const winnerName = document.getElementById("winner-name");
          let semifinalists = [];
          let winner = null;

          function updateSemifinalists() {
            semifinalistsList.innerHTML = "";
            semifinalists.forEach((player) => {
              const radio = document.createElement("input");
              radio.type = "radio";
              radio.name = "winner";
              radio.value = player.name;
              radio.onchange = () => {
                winner = player.name;
                winnerName.innerText = player.name;
              };

              const label = document.createElement("label");
              label.textContent = player.name;

              const div = document.createElement("div");
              div.classList.add("player");
              div.appendChild(radio);
              div.appendChild(label);
              semifinalistsList.appendChild(div);
            });
          }

          players.forEach((player) => {
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.value = player.name;
            checkbox.onchange = () => {
              if (checkbox.checked) {
                if (semifinalists.length < 4) {
                  semifinalists.push(player);
                } else {
                  checkbox.checked = false;
                  alert("Puoi selezionare massimo 4 semifinalisti!");
                }
              } else {
                semifinalists = semifinalists.filter(
                  (p) => p.name !== player.name
                );
              }
              updateSemifinalists();
            };

            const label = document.createElement("label");
            label.textContent = player.name;

            const div = document.createElement("div");
            div.classList.add("player");
            div.appendChild(checkbox);
            div.appendChild(label);

            playersList.appendChild(div);
          });

          document
            .getElementById("selection-form")
            .addEventListener("submit", (event) => {
              event.preventDefault();
              const email = document.getElementById("email").value;

              if (semifinalists.length !== 4) {
                alert("Seleziona esattamente 4 semifinalisti!");
                return;
              }
              if (!winner) {
                alert("Seleziona un vincitore!");
                return;
              }

              const data = {
                email: email,
                semifinalists: semifinalists.map((p) => p.name),
                winner: winner,
              };

              fetch("https://doha-srv.onrender.com", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
              })
                .then((response) => response.json())
                .then((result) => alert(result.message))
                .catch((error) => console.error("Errore:", error));
            });
        })
        .catch((error) =>
          console.error("Errore nel caricamento del file JSON:", error)
        );
    </script>
  </body>
</html>
